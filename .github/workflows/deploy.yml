name: Deploy to cPanel

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Prepare deployment files
        run: |
          # Create deployment directory
          mkdir -p deploy

          # Copy built frontend
          cp -r dist/* deploy/

          # Copy API folder
          cp -r api deploy/

          # Create/update .htaccess for React Router SPA
          cat > deploy/.htaccess << 'EOF'
          # Enable RewriteEngine
          RewriteEngine On

          # Handle API requests
          RewriteRule ^api/(.*)$ api/index.php [L,QSA]

          # React Router - Handle client-side routing
          RewriteBase /
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteCond %{REQUEST_URI} !^/api/
          RewriteRule ^ index.html [L]

          # Security Headers
          <IfModule mod_headers.c>
            Header set X-Content-Type-Options "nosniff"
            Header set X-Frame-Options "SAMEORIGIN"
            Header set X-XSS-Protection "1; mode=block"
          </IfModule>

          # Protect sensitive files
          <FilesMatch "\.(json|php\.bak|env)$">
            <IfModule mod_authz_core.c>
              Require all denied
            </IfModule>
            <IfModule !mod_authz_core.c>
              Order deny,allow
              Deny from all
            </IfModule>
          </FilesMatch>

          # Allow access to specific API files
          <FilesMatch "^(index\.php)$">
            <IfModule mod_authz_core.c>
              Require all granted
            </IfModule>
          </FilesMatch>

          # CORS Headers for API
          <IfModule mod_headers.c>
            <FilesMatch "\.php$">
              Header set Access-Control-Allow-Origin "*"
              Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
              Header set Access-Control-Allow-Headers "Content-Type, Authorization"
            </FilesMatch>
          </IfModule>

          # Compression
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
          </IfModule>

          # Caching for static assets
          <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/javascript "access plus 1 month"
            ExpiresByType text/javascript "access plus 1 month"
          </IfModule>
          EOF

          echo "Deployment files prepared successfully"

      - name: Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/README.md
            **/DEPLOYMENT.md

      - name: Deployment complete
        run: |
          echo "Deployment completed successfully!"
          echo "Your application should now be live at your cPanel domain."
